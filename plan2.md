# Plan for Generating and Querying Audit Log Test Data

This document outlines a plan to generate test data for audit log scenarios, seed it into an Elasticsearch cluster, and then query it directly.

## 1. Test Data Generation

We will create a JSON file named `test_data.json` containing sample audit log entries for the following scenarios:

*   A user uploads a file.
*   A user grants access to the file to another user.
*   A user revokes access to the file.

Each entry will conform to the audit log model and will include a pre-computed embedding vector for the `embedding_vector` field. For this plan, we will assume the use of a sentence-transformer model like `all-MiniLM-L6-v2`, which produces a 384-dimension vector.

**File: `test_data.json`** (Abridged example)
```json
[
  {
    "id": "1a7a8c42-8a77-4e1e-a54b-9e3f3d245d1f", "action": "file.upload", "summary": "A user uploaded a file.", "description": "User Alice uploaded the file 'financials_q3.docx' from IP 192.168.1.10.", "ip_address": "192.168.1.10", "occured_at": "2025-07-24T10:00:00Z", "created_at": "2025-07-24T10:00:05Z", "actor_id": "a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6", "organization_id": "org-1",
    "target_entities": [{ "id": "e6a7b8c9-d0e1-f2a3-b4c5-d6e7f8a9b0c1", "type": "file" }],
    "embedding_vector": [0.01, ..., -0.02] 
  },
  {
    "id": "f47ac10b-58cc-4372-a567-0e02b2c3d479", "action": "file.grant_access", "summary": "A user granted access to a file.", "description": "User Alice granted read access to the file 'financials_q3.docx' to user Bob.", "ip_address": "192.168.1.10", "occured_at": "2025-07-24T11:00:00Z", "created_at": "2025-07-24T11:00:05Z", "actor_id": "a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6", "organization_id": "org-1",
    "target_entities": [{ "id": "e6a7b8c9-d0e1-f2a3-b4c5-d6e7f8a9b0c1", "type": "file" }, { "id": "b0b1c2d3-e4f5-a6b7-c8d9-e0f1a2b3c4d5", "type": "user" }],
    "embedding_vector": [0.03, ..., 0.05]
  },
  {
    "id": "b4a8c2f0-9e3f-4d24-a54b-8a774e1e1a7a", "action": "file.revoke_access", "summary": "A user revoked access to a file.", "description": "User Alice revoked access to the file 'financials_q3.docx' from user Bob.", "ip_address": "192.168.1.10", "occured_at": "2025-07-24T12:00:00Z", "created_at": "2025-07-24T12:00:05Z", "actor_id": "a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6", "organization_id": "org-1",
    "target_entities": [{ "id": "e6a7b8c9-d0e1-f2a3-b4c5-d6e7f8a9b0c1", "type": "file" }, { "id": "b0b1c2d3-e4f5-a6b7-c8d9-e0f1a2b3c4d5", "type": "user" }],
    "embedding_vector": [-0.04, ..., 0.01]
  }
]
```
*(Note: The `embedding_vector` arrays will need to be fully populated with 384 floating-point numbers from an actual sentence-transformer model.)*

## 2. Seeding Data into Elasticsearch

A shell script, `seed.sh`, will be created to automate the process of setting up the index and ingesting the test data.

**File: `seed.sh`**
```bash
#!/bin/bash

ES_HOST="http://localhost:9200"
INDEX_NAME="audit_logs"

# 1. Delete the existing index (optional, for a clean start)
curl -X DELETE "${ES_HOST}/${INDEX_NAME}"

# 2. Create the index with the correct mapping
curl -X PUT "${ES_HOST}/${INDEX_NAME}" -H 'Content-Type: application/json' -d'
{
  "mappings": {
    "properties": {
      "id": { "type": "keyword" },
      "action": { "type": "keyword" },
      "summary": { "type": "text" },
      "description": { "type": "text" },
      "ip_address": { "type": "ip" },
      "occured_at": { "type": "date" },
      "created_at": { "type": "date" },
      "actor_id": { "type": "keyword" },
      "organization_id": { "type": "keyword" },
      "target_entities": {
        "type": "nested",
        "properties": {
          "id": { "type": "keyword" },
          "type": { "type": "keyword" }
        }
      },
      "embedding_vector": {
        "type": "dense_vector",
        "dims": 384 
      }
    }
  }
}
'

# 3. Ingest the test data using the Bulk API
# The test_data.json needs to be converted to the bulk format.
# This can be done with a simple script or manually for a small dataset.
# Example bulk format line:
# {"index": {"_index": "audit_logs", "_id": "log-001"}}
# { "id": "log-001", "action": "file.upload", ... }

echo "Creating bulk data file..."
jq -c '.[]' test_data.json | while read -r line; do
    id=$(echo "$line" | jq -r '.id')
    echo "{\"index\": {\"_index\": \"$INDEX_NAME\", \"_id\": \"$id\"}}"
    echo "$line"
done > bulk_data.json

curl -s -X POST "${ES_HOST}/_bulk" -H "Content-Type: application/x-ndjson" --data-binary "@bulk_data.json"

echo "Seeding complete."
```

## 3. Querying Elasticsearch

With the data indexed, we can perform queries directly against the Elasticsearch API using `curl`.

### a. Keyword Search

Search for logs related to "Bob".

```bash
curl -X GET "http://localhost:9200/audit_logs/_search" -H 'Content-Type: application/json' -d' -H 'Authorization: ApiKey eEhvdkc1Z0JmbHRob19UMkx2Nzk6bkVMZTZObnZ6M3hTbkRLcjF6VF9rQQ=='
{
  "query": {
    "multi_match": {
      "query": "Bob",
      "fields": ["summary", "description"]
    }
  }
}
'
```

### b. Hybrid Search

Search for the concept of "removing access to financials". This query will require generating an embedding for the search phrase.

```bash
# Step 1: Get the embedding for "removing access to financials" from a model.
# (This is a placeholder for the actual vector)
QUERY_VECTOR="[0.014606357552111149,0.09046093374490738,-0.083375945687294,0.010992354713380337,-0.04682578518986702,0.03117401711642742,0.06994810700416565,-0.08996526151895523,0.048934537917375565,-0.010604001581668854,-0.006905728951096535,0.04254524037241936,-0.014400701969861984,-0.08460958302021027,-0.04456495866179466,-0.07908441871404648,-0.04506507143378258,-0.0033179717138409615,0.007234412245452404,0.1023692712187767,0.007083234842866659,-0.04405994713306427,-0.045345239341259,0.031196027994155884,0.11536937206983566,-0.015376723371446133,-0.000977113377302885,0.022807031869888306,0.005850246641784906,-0.03196787089109421,0.05005379393696785,0.01781606674194336,0.016358831897377968,-0.01937999576330185,0.07900562137365341,-0.02270985022187233,0.019176732748746872,0.06735820323228836,0.0443883053958416,-0.05465847626328468,-0.030948830768465996,-0.004397614859044552,0.027055544778704643,-0.027123700827360153,0.042438361793756485,0.019505975767970085,0.0195463914424181,0.0023938112426549196,0.028694383800029755,0.08736769109964371,0.0016255466034635901,0.04827581346035004,-0.029231781139969826,0.023381398990750313,-0.03377514332532883,0.018304336816072464,0.1258954256772995,-0.037752795964479446,-0.017114074900746346,-0.03154797852039337,-0.0020174894016236067,0.029310254380106926,0.054362326860427856,-0.011997842229902744,-0.008414022624492645,0.06003168225288391,0.018835747614502907,0.04404658451676369,-0.005002980586141348,0.03627163544297218,0.019425570964813232,-0.07262800633907318,-0.0923861488699913,-0.032465919852256775,0.07824881374835968,0.06538261473178864,-0.04845820739865303,0.057949308305978775,0.02263748273253441,-0.0031818519346415997,0.06526162475347519,-0.026892708614468575,-0.022017348557710648,-0.033823080360889435,-0.13317269086837769,0.04603719338774681,-0.04165790602564812,-0.06341966986656189,0.09262653440237045,0.001696237944997847,0.05223062261939049,0.003225927473977208,0.10129556059837341,-0.026539266109466553,0.0008271133410744369,-0.14283205568790436,0.07128095626831055,-0.05569813400506973,0.0016332139493897557,0.03808815777301788,0.01864154264330864,0.009666119702160358,-0.0016762294108048081,0.013755381107330322,-0.03815021365880966,0.011117125861346722,0.06589942425489426,0.09363654255867004,0.02213376760482788,-0.03441953286528587,-0.002940503181889653,0.011530671268701553,-0.030422838404774666,0.0018328462028875947,-0.036978960037231445,0.04202171042561531,-0.09022773802280426,0.030792657285928726,-0.0016021199990063906,0.04780234396457672,0.009995252825319767,0.12831896543502808,-0.044399283826351166,0.006226652301847935,-0.03009638749063015,-0.008571104146540165,-0.13130657374858856,-2.0714813079449823e-33,-0.04334450885653496,-0.005540008656680584,0.022231265902519226,-0.08450787514448166,0.052378904074430466,0.02401377074420452,-0.010632594116032124,-0.05252816528081894,-0.0833427831530571,0.05999322235584259,0.02973986603319645,0.12165907770395279,-0.005695387255400419,-0.11039873212575912,0.03258180990815163,-0.020526619628071785,0.03810345381498337,0.02713201195001602,0.08216734230518341,0.00040224051917903125,0.05801795423030853,0.045489538460969925,0.05589064210653305,-0.034355442970991135,0.043245136737823486,-0.029758034273982048,-0.09951625764369965,-0.010192089714109898,0.022223522886633873,0.010488154366612434,0.034521494060754776,-6.15063909208402e-05,0.03907220438122749,-0.0059531149454414845,0.04647368937730789,0.0013773755636066198,0.012623281218111515,-0.02574177086353302,0.011981549672782421,-0.017832858487963676,-0.043609052896499634,-0.04176846891641617,0.01311384979635477,0.020363597199320793,-0.015648609027266502,0.028401566669344902,0.038052238523960114,0.08079210668802261,-0.03707721829414368,0.033654436469078064,-0.050622161477804184,-0.006576855666935444,-0.05856817588210106,-0.05073646828532219,-0.11050011962652206,-0.07214800268411636,-0.02763892337679863,-0.080889031291008,-0.048075929284095764,-0.16942621767520905,0.03429224342107773,-0.030788766220211983,0.0006027899798937142,0.0041256495751440525,-0.11320056021213531,0.032895736396312714,-0.011585267260670662,0.0363137312233448,-0.020003683865070343,-0.011324064806103706,-0.0777737945318222,0.02279575541615486,0.04291535168886185,0.05058101937174797,-0.045514289289712906,0.020636899396777153,0.022728312760591507,0.044814739376306534,0.030919402837753296,0.07433035969734192,0.07946111261844635,-0.012688367627561092,0.02527197077870369,0.11043281108140945,0.06811690330505371,0.034466054290533066,-0.006738138385117054,-0.02492350898683071,0.0791434496641159,-0.0051965778693556786,-0.05524400994181633,-0.015695303678512573,-0.004515110049396753,0.035669781267642975,-0.00845471303910017,-9.689090246824439e-34,-0.010880186222493649,-0.049942679703235626,0.03144557774066925,-0.12673449516296387,-0.10001692920923233,0.00802648440003395,0.021126560866832733,-0.03142716363072395,-0.01596430316567421,-0.0014130519703030586,-0.004478792659938335,0.0035134933423250914,0.023738916963338852,-0.06505477428436279,-0.06094779446721077,-0.01656770333647728,0.038549039512872696,-0.024770913645625114,-0.03629867732524872,-0.009731179103255272,-0.07423347234725952,0.04906687140464783,0.10897358506917953,0.02688640169799328,-0.017877692356705666,0.01663879305124283,-0.056704211980104446,0.01444712933152914,-0.0018376423977315426,0.05876602232456207,-0.04351387545466423,-5.445859642350115e-05,0.022767504677176476,-0.05630989372730255,-0.05526362732052803,-0.08691705763339996,-0.031089266762137413,0.047118328511714935,-0.015543021261692047,0.02394270896911621,0.019472183659672737,0.008516842499375343,-0.007756800856441259,-0.05012323334813118,0.060574669390916824,-0.025308605283498764,-0.025416040793061256,-0.03548659384250641,0.046212099492549896,-0.010426527820527554,-0.0014713555574417114,-0.05229360610246658,0.10314415395259857,0.013901823200285435,-0.048843543976545334,0.10073161125183105,0.13189153373241425,-0.051844991743564606,0.08560788631439209,-0.024548910558223724,0.018790926784276962,0.06104915961623192,-0.040715426206588745,0.09125299006700516,0.006311145145446062,-0.06325947493314743,-0.029190586879849434,-0.019120996817946434,-0.020588140934705734,-0.05350415036082268,0.019174402579665184,-0.06205306202173233,0.040658436715602875,-0.007157280575484037,0.06599938124418259,0.08520059287548065,-0.07676892727613449,-0.01365566998720169,-0.04061517491936684,-0.0015115384012460709,0.04184553772211075,-0.017771851271390915,4.149352025706321e-05,-0.0786486566066742,-0.052029047161340714,-0.06526569277048111,-0.008777974173426628,-0.13331659138202667,-0.0004118758952245116,0.006490339059382677,-0.021383509039878845,-0.04197379946708679,0.06954456120729446,0.03422733396291733,-0.09219513088464737,-1.4451948082694344e-08,0.038008641451597214,-0.024607917293906212,0.03392811864614487,0.032905422151088715,0.04448994621634483,-0.09175213426351547,-0.08703070878982544,0.1019628643989563,0.022714396938681602,-0.024844644591212273,0.02997010387480259,0.04620150849223137,-0.019455106928944588,-0.031966738402843475,-0.04814358428120613,-0.005092653911560774,-0.028306983411312103,-0.07152591645717621,0.015916207805275917,0.020025886595249176,-0.04422331601381302,-0.030606266111135483,0.018700474873185158,0.005663573741912842,0.009695878252387047,-0.05079708248376846,0.01631460152566433,0.030810562893748283,0.061289913952350616,0.05977990850806236,-0.062441326677799225,-0.03318726271390915,0.05195791646838188,0.054267242550849915,-0.07822228223085403,-0.00254750601015985,-0.00918992143124342,0.030212977901101112,-0.10561168938875198,0.06433738023042679,0.013717438094317913,0.037804216146469116,-0.015009025111794472,0.02083592675626278,-0.07728760689496994,-0.05229976028203964,-0.04204898700118065,-0.0025332130026072264,0.08214050531387329,-0.068113774061203,0.03984706848859787,0.01833639107644558,0.00037223577965050936,0.018565909937024117,-0.010245715267956257,0.024410875514149666,0.004086997825652361,0.059359170496463776,-0.1556071788072586,-0.025203565135598183,0.0352557897567749,-0.040167100727558136,-0.004783845040947199,-0.04108300432562828]" 

# Step 2: Run the hybrid query
curl -X GET "http://localhost:9200/audit_logs/_search" \
  -H 'Content-Type: application/json' \
  -u 'elastic:b1V4R0Re' \
  -d '{
  "query": {
    "multi_match": {
      "query": "removing access to financials",
      "fields": ["summary", "description"]
    }
  },
  "knn": {
    "field": "embedding_vector",
    "query_vector": '$QUERY_VECTOR',
    "k": 2,
    "num_candidates": 10
  },
  "rank": {
    "rrf": {}
  }
}
'
```
This plan provides a complete workflow for testing the audit log system, from data creation to advanced querying.
